<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Battle Arcade</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0e1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Battle Arcade">
<link rel="apple-touch-icon" href="icon-180.png">
<style>
:root{
  --bg:#0b0e1a; --card:#111735; --line:#1c2450; --txt:#e8ecff; --mut:#94a7cc;
  --brand:#57d0ff; --ok:#21d19f; --bad:#ff5470; --chip:#0e1533;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1100px 700px at 50% -120px,#142861 0%,#0b0e1a 55%);color:var(--txt);padding:16px}
h1{margin:0 0 6px;font-size:24px}
.grid{display:grid;grid-template-columns:280px 1fr;gap:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
.btn{border:0;border-radius:14px;padding:12px 16px;font-weight:800;cursor:pointer}
.btn.pri{background:linear-gradient(180deg,#6fe1ff,#2b9dff);color:#00122a}
.btn.sec{background:#0d152e;color:var(--txt);border:1px solid var(--line)}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,textarea,input{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:#0c1225;color:var(--txt)}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;margin:4px 4px 0 0;border-radius:999px;background:#0d152e;border:1px solid var(--line);font-size:13px}
.list{min-height:80px}
.hidden{display:none}
.duel{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:start}
.slot{display:flex;flex-direction:column;gap:10px}
.shot{width:100%;max-width:320px;aspect-ratio:1/1;border-radius:16px;border:1px solid var(--line);background:#0c1225;object-fit:cover}
.name{font-size:18px;font-weight:800;text-align:center}
.thumbs{display:flex;gap:8px;overflow:auto;padding-bottom:4px}
.thumbs img{width:72px;height:72px;border-radius:10px;border:1px solid var(--line);background:#0c1225;object-fit:cover;flex:0 0 auto;cursor:pointer}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{border:1px solid var(--line);background:var(--chip);color:var(--mut);font-size:12px;padding:6px 10px;border-radius:10px}
.chip a{color:#9ed2ff;text-decoration:none}
.choose{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.ok{background:linear-gradient(180deg,#5dffce,#16c48a);color:#001a12}
.bad{background:linear-gradient(180deg,#ff9ab0,#ff5470);color:#2a0009}
.video{width:100%;max-width:320px;aspect-ratio:16/9;border-radius:12px;border:1px solid var(--line);background:#000}
.sub{color:var(--mut);font-size:12px}
h2{font-size:16px;margin:8px 0 4px}
</style>
</head>
<body>
  <h1>🎮 Battle Arcade</h1>
  <div class="sub">Wähle einen Modus. Alles funktioniert als ZIP/PWA ohne Server. Bilder: Openverse & Wikipedia + eigene URLs/Dateien. Songs: iTunes‑Previews (30s) automatisch, optional YouTube‑Embed per URL.</div>

  <div class="grid">
    <div class="card">
      <h2>Modus</h2>
      <select id="mode">
        <option value="games">Videospiele‑Battle</option>
        <option value="songs">Song‑Battle</option>
        <option value="celeb">Promi‑Battle</option>
        <option value="adult">Adult‑Star‑Battle</option>
        <option value="streamer">Streamer‑Battle</option>
        <option value="custom">Eigene Liste</option>
      </select>

      <div id="songPane" class="hidden">
        <h2>Genre (Songs)</h2>
        <select id="genre">
          <option>pop</option><option>hip hop</option><option>rock</option><option>electronic</option><option>metal</option><option>jazz</option>
        </select>
        <div class="sub">Es werden automatisch 10 zufällige Songs via iTunes‑Search geladen (CORS‑freundlich). Du kannst optional eine YouTube‑URL einfügen, um das Video einzubetten.</div>
      </div>

      <h2>Duell‑Ziel</h2>
      <input id="target" type="number" value="1" min="1">

      <h2>Namen (für „Eigene Liste“)</h2>
      <textarea id="names" rows="8" placeholder="Name 1
Name 2
Name 3"></textarea>

      <div class="row" style="margin-top:10px">
        <button class="btn pri" id="startBtn">Start</button>
        <button class="btn sec" id="demoBtn">Demo</button>
      </div>

      <div style="margin-top:10px">
        <div class="sub">Drin</div>
        <div id="listIn" class="list"></div>
        <div class="sub" style="margin-top:10px">Raus</div>
        <div id="listOut" class="list"></div>
      </div>
    </div>

    <div class="card">
      <div id="arena" class="hidden">
        <div class="duel">
          <div class="slot">
            <img id="li" class="shot" src="assets/placeholder.png" alt="links">
            <div id="lname" class="name">–</div>
            <div id="laudioWrap" class="hidden"><audio id="laudio" controls></audio></div>
            <iframe id="lyt" class="video hidden" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            <div class="chips" id="lchips"></div>
            <div class="thumbs" id="lgal"></div>
          </div>
          <div style="align-self:center;font-weight:900;opacity:.9">VS</div>
          <div class="slot">
            <img id="ri" class="shot" src="assets/placeholder.png" alt="rechts">
            <div id="rname" class="name">–</div>
            <div id="raudioWrap" class="hidden"><audio id="raudio" controls></audio></div>
            <iframe id="ryt" class="video hidden" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            <div class="chips" id="rchips"></div>
            <div class="thumbs" id="rgal"></div>
          </div>
        </div>

        <div class="choose" style="margin-top:10px">
          <button class="btn ok" id="chooseLeft">⬅️ Links gewinnt</button>
          <button class="btn bad" id="chooseRight">Rechts gewinnt ➡️</button>
        </div>

        <div class="row" style="margin-top:10px;justify-content:space-between">
          <div class="row">
            <button class="btn sec" id="undoBtn" disabled>Rückgängig</button>
            <button class="btn sec" id="shuffleBtn">Neu mischen</button>
          </div>
          <div class="sub" id="status"></div>
        </div>
      </div>

      <div id="result" class="hidden">
        <h2>🏆 Übrig</h2>
        <div id="survivors"></div>
      </div>
    </div>
  </div>

<script>
const $=s=>document.querySelector(s);
const modeEl=$('#mode'), genreEl=$('#genre'), songPane=$('#songPane');
const namesEl=$('#names'), targetEl=$('#target'), startBtn=$('#startBtn'), demoBtn=$('#demoBtn');
const arena=$('#arena'), result=$('#result'), survivors=$('#survivors');
const li=$('#li'), ri=$('#ri'), lname=$('#lname'), rname=$('#rname');
const lgal=$('#lgal'), rgal=$('#rgal'), lchips=$('#lchips'), rchips=$('#rchips');
const chooseLeft=$('#chooseLeft'), chooseRight=$('#chooseRight'), undoBtn=$('#undoBtn'), shuffleBtn=$('#shuffleBtn'), status=$('#status');
const laudioWrap=$('#laudioWrap'), raudioWrap=$('#raudioWrap'), laudio=$('#laudio'), raudio=$('#raudio');
const lyt=$('#lyt'), ryt=$('#ryt');
const listIn=$('#listIn'), listOut=$('#listOut');

let pool=[], out=[], currentPair=[], history=[], target=1;
const OPENVERSE=(q,n=12)=>`https://api.openverse.engineering/v1/images/?q=${encodeURIComponent(q)}&page_size=${n}&mature=true`;
const WIKI=(q,size=380)=>`https://de.wikipedia.org/w/api.php?action=query&format=json&origin=*&prop=pageimages&piprop=thumbnail&pithumbsize=${size}&generator=search&gsrlimit=1&gsrsearch=${encodeURIComponent(q)}`;
modeEl.onchange=()=> songPane.classList.toggle('hidden', modeEl.value!=='songs');

function uniq(a){return Array.from(new Set(a));}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

async function wikiThumb(q){
  try{const r=await fetch(WIKI(q));const j=await r.json();if(j&&j.query&&j.query.pages){const v=Object.values(j.query.pages)[0];if(v&&v.thumbnail) return v.thumbnail.source;}}catch(e){}
  return null;
}
async function openverseThumbs(q,n=12){
  try{const r=await fetch(OPENVERSE(q,n)); if(!r.ok) return []; const j=await r.json(); return (j.results||[]).map(it=>({src:it.thumbnail||it.url, page:it.foreign_landing_url||it.url}));}catch(e){return [];}
}

function searchChips(name, el, type){
  el.innerHTML='';
  const engines=[
    {k:'Google',u:'https://www.google.com/search?tbm=isch&safe=off&q='+encodeURIComponent(name)},
    {k:'Bing',u:'https://www.bing.com/images/search?q='+encodeURIComponent(name)+'&safeSearch=Off'},
    {k:'Yandex',u:'https://yandex.com/images/search?text='+encodeURIComponent(name)},
    {k:'DuckDuckGo',u:'https://duckduckgo.com/?ia=images&iax=images&kp=-2&q='+encodeURIComponent(name)}
  ];
  if(type==='song'){
    engines.unshift({k:'YouTube',u:'https://www.youtube.com/results?search_query='+encodeURIComponent(name)});
  }
  engines.forEach(e=>{ const c=document.createElement('span'); c.className='chip'; c.innerHTML='<a target="_blank" href="'+e.u+'">🔎 '+e.k+'</a>'; el.appendChild(c); });
}

async function renderSide(name, bigEl, galEl, chipsEl, type, audioEl, ytEl){
  bigEl.src='assets/placeholder.png'; galEl.innerHTML=''; chipsEl.innerHTML='';
  searchChips(name, chipsEl, type);

  if(type==='song'){
    ytEl.classList.add('hidden'); ytEl.src='';
  }

  if(type!=='song'){
    const w = await wikiThumb(name);
    if(w) bigEl.src = w;
    const ov = await openverseThumbs(name, 18);
    ov.forEach(it=>{ const im=document.createElement('img'); im.src=it.src; im.onclick=()=>{ bigEl.src=it.src; }; galEl.appendChild(im); });
  }
}

function drawPair(){
  if(pool.length<=1) return;
  const a=Math.floor(Math.random()*pool.length); let b=Math.floor(Math.random()*pool.length); while(b===a) b=Math.floor(Math.random()*pool.length);
  currentPair=[pool[a], pool[b]];
  lname.textContent=currentPair[0].title || currentPair[0]; rname.textContent=currentPair[1].title || currentPair[1];

  if(modeEl.value==='songs'){
    const L=currentPair[0], R=currentPair[1];
    laudio.src=L.previewUrl || ''; raudio.src=R.previewUrl || '';
    laudioWrap.classList.toggle('hidden', !L.previewUrl); raudioWrap.classList.toggle('hidden', !R.previewUrl);
    renderSide(`${L.artist} ${L.title}`, li, lgal, lchips, 'song', laudio, lyt);
    renderSide(`${R.artist} ${R.title}`, ri, rgal, rchips, 'song', raudio, ryt);
    // YouTube prompt chips
    const addChip = (chipsEl, obj, ytEl)=>{
      const s=document.createElement('span'); s.className='chip'; s.textContent='YouTube-URL einfügen →';
      s.onclick=()=>{const u=prompt('YouTube-URL für '+(obj.title||obj)); if(u){ const id=(u.match(/[?&]v=([^&]+)/)||u.match(/youtu\.be\/([^?]+)/)||[])[1]; if(id){ ytEl.src='https://www.youtube-nocookie.com/embed/'+id+'?autoplay=1'; ytEl.classList.remove('hidden'); }}};
      chipsEl.appendChild(s);
    };
    addChip(lchips, L, lyt); addChip(rchips, R, ryt);
  } else {
    renderSide(currentPair[0], li, lgal, lchips, 'img');
    renderSide(currentPair[1], ri, rgal, rchips, 'img');
  }
  status.textContent = pool.length + ' aktiv | Ziel: ' + target;
}

async function start(){
  target=Math.max(1, parseInt(targetEl.value||'1',10));
  out=[]; history=[];
  const m=modeEl.value;
  if(m==='custom'){
    pool = uniq(namesEl.value.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean));
  } else if(m==='games'){
    const built = [
      'Super Mario Bros.','The Legend of Zelda','Metroid','Halo 3','God of War','The Witcher 3','Elden Ring','Minecraft','Fortnite','Street Fighter II','Tekken 7','Gran Turismo 7','Forza Horizon 5','Tetris','Portal 2','Half-Life 2','Doom','Super Mario 64','Bloodborne','Red Dead Redemption 2'
    ];
    pool = shuffle(built).slice(0, 12);
  } else if(m==='celeb'){
    const built=['Tom Cruise','Natalie Portman','Margot Robbie','Zendaya','Keanu Reeves','Rihanna','Ariana Grande','Angelina Jolie','Brad Pitt','Ryan Gosling','Emma Stone','Dwayne Johnson','Scarlett Johansson'];
    pool = shuffle(built).slice(0, 12);
  } else if(m==='adult'){
    const built=['Mia Malkova','Johnny Sins','Abella Danger','Riley Reid','Lana Rhoades','Adriana Chechik','Angela White','Violet Myers','Eva Elfie','Lexi Belle','Nikki Benz','Kendra Lust'];
    pool = shuffle(built).slice(0, 12);
  } else if(m==='streamer'){
    const built=['xQc','pokimane','Ibai','Asmongold','Ninja','hasanabi','Kai Cenat','Ludwig Ahgren','Valkyrae','sodapoppin','Summit1g','Shroud'];
    pool = shuffle(built).slice(0, 12);
  } else if(m==='songs'){
    const g = genreEl.value || 'pop';
    let res=[];
    try{
      const r=await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(g)}&media=music&entity=song&limit=50`);
      const j=await r.json();
      res = j.results.map(x=>({title:x.trackName, artist:x.artistName, previewUrl:x.previewUrl}));
    }catch(_){}
    shuffle(res);
    pool = res.slice(0,10);
  }
  if(pool.length<2 || target>=pool.length){ alert('Mind. 2 Einträge & Ziel kleiner als Anzahl.'); return; }

  listIn.innerHTML=''; listOut.innerHTML='';
  pool.forEach(n=>{ const d=document.createElement('div'); d.className='pill'; d.textContent=(n.title?n.artist+' – '+n.title:n); listIn.appendChild(d); });

  arena.classList.remove('hidden'); result.classList.add('hidden');
  drawPair(); undoBtn.disabled=true;
}

function pick(idx){
  if(currentPair.length<2) return;
  const w=currentPair[idx], l=currentPair[1-idx];
  pool = pool.filter(n=>n!==w && n!==l); pool.push(w); out.push(l);
  history.push({w,l}); undoBtn.disabled=false;
  listIn.innerHTML=''; listOut.innerHTML='';
  pool.forEach(n=>{ const d=document.createElement('div'); d.className='pill'; d.textContent=(n.title?n.artist+' – '+n.title:n); listIn.appendChild(d); });
  out.forEach(n=>{ const d=document.createElement('div'); d.className='pill'; d.textContent=(n.title?n.artist+' – '+n.title:n); listOut.appendChild(d); });
  if(pool.length<=target){
    arena.classList.add('hidden'); result.classList.remove('hidden'); survivors.innerHTML='';
    pool.forEach(n=>{ const d=document.createElement('div'); d.className='pill'; d.textContent=(n.title?n.artist+' – '+n.title:n); survivors.appendChild(d); });
    return;
  }
  drawPair();
}
function undo(){
  const h=history.pop(); if(!h) return;
  pool = pool.filter(n=>n!==h.w); const j=out.lastIndexOf(h.l); if(j>-1) out.splice(j,1);
  pool.push(h.w,h.l); undoBtn.disabled = history.length===0;
  listIn.innerHTML=''; listOut.innerHTML='';
  pool.forEach(n=>{ const d=document.createElement('div'); d.className='pill'; d.textContent=(n.title?n.artist+' – '+n.title:n); listIn.appendChild(d); });
  out.forEach(n=>{ const d=document.createElement('div'); d.className='pill'; d.textContent=(n.title?n.artist+' – '+n.title:n); listOut.appendChild(d); });
  drawPair();
}

startBtn.onclick=start;
demoBtn.onclick=()=>{ modeEl.value='games'; songPane.classList.add('hidden'); namesEl.value=''; };
chooseLeft.onclick=()=>pick(0);
chooseRight.onclick=()=>pick(1);
undoBtn.onclick=undo;
shuffleBtn.onclick=drawPair;

// PWA
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(()=>{}) ); }
</script>
</body>
</html>
